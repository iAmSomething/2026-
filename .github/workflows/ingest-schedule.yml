name: Ingest Schedule

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  scheduled-ingest:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      DATA_GO_KR_KEY: ${{ secrets.DATA_GO_KR_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      INTERNAL_JOB_TOKEN: ${{ secrets.INTERNAL_JOB_TOKEN }}
      API_BASE_URL: http://127.0.0.1:8100
      INGEST_SCHEDULE_PAYLOAD: data/collector_live_payload.json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Secret preflight (fail-fast)
        run: |
          scripts/qa/preflight_required_secrets.sh

      - name: Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Create venv and install deps
        run: |
          python -m venv .venv
          .venv/bin/pip install -r requirements.txt

      - name: Build live coverage payload
        run: |
          chmod +x scripts/qa/build_live_coverage_payload.sh
          scripts/qa/build_live_coverage_payload.sh \
            --python .venv/bin/python \
            --canonical-payload "$INGEST_SCHEDULE_PAYLOAD" \
            --route-report data/ingest_schedule_payload_route_report.json
          test -s "$INGEST_SCHEDULE_PAYLOAD"
          test -s data/ingest_schedule_payload_route_report.json
          cat data/ingest_schedule_payload_route_report.json

      - name: Start API server
        run: |
          nohup .venv/bin/uvicorn app.main:app --host 127.0.0.1 --port 8100 >/tmp/ingest-schedule-api.log 2>&1 &
          for _ in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:8100/health >/dev/null 2>&1; then
              exit 0
            fi
            sleep 1
          done
          echo "::error::API server failed to start"
          exit 1

      - name: DB preflight via health/db
        run: |
          DB_HEALTH_STATUS="$(curl -sS -o /tmp/ingest-schedule-health-db.json -w "%{http_code}" http://127.0.0.1:8100/health/db || true)"
          echo "health_db_http_status=${DB_HEALTH_STATUS}"
          echo "===== /tmp/ingest-schedule-health-db.json ====="
          cat /tmp/ingest-schedule-health-db.json || true
          if [ "${DB_HEALTH_STATUS}" != "200" ]; then
            echo "::error::DB preflight failed (/health/db status=${DB_HEALTH_STATUS})"
            exit 1
          fi

      - name: Run scheduled ingest with retry
        run: |
          .venv/bin/python scripts/qa/run_ingest_with_retry.py \
            --api-base "$API_BASE_URL" \
            --input "$INGEST_SCHEDULE_PAYLOAD" \
            --max-retries 2 \
            --backoff-seconds 1 \
            --timeout 180 \
            --timeout-scale-on-timeout 1.5 \
            --timeout-max 360 \
            --allow-partial-success \
            --classification-artifact data/ingest_schedule_failure_classification.json \
            --comment-template-path data/ingest_schedule_failure_comment_template.md \
            --dead-letter-dir data/dead_letter \
            --report data/ingest_schedule_report.json

      - name: Dump API server log on failure
        if: failure()
        run: |
          echo "===== /tmp/ingest-schedule-api.log ====="
          cat /tmp/ingest-schedule-api.log || true

      - name: Ensure ingest diagnostics artifacts exist
        if: always()
        run: |
          .venv/bin/python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone
          from pathlib import Path

          report_path = Path("data/ingest_schedule_report.json")
          payload_path = Path(os.environ.get("INGEST_SCHEDULE_PAYLOAD", "data/collector_live_payload.json"))
          classification_path = Path("data/ingest_schedule_failure_classification.json")
          comment_template_path = Path("data/ingest_schedule_failure_comment_template.md")

          report = {}
          if report_path.exists():
              report = json.loads(report_path.read_text(encoding="utf-8"))

          payload = {}
          if payload_path.exists():
              payload = json.loads(payload_path.read_text(encoding="utf-8"))

          if not classification_path.exists():
              attempts = report.get("attempts") or []
              failure_counts = {}
              for item in attempts:
                  key = item.get("failure_class") or "none"
                  failure_counts[key] = failure_counts.get(key, 0) + 1
              artifact = {
                  "schema_version": "collector_ingest_failure_classification.v1",
                  "generated_at": datetime.now(timezone.utc).isoformat(),
                  "source_input_path": str(payload_path),
                  "payload_run_type": payload.get("run_type"),
                  "payload_record_count": len(payload.get("records") or []),
                  "runner": {
                      "success": bool(report.get("success")),
                      "raw_success": bool(report.get("raw_success", report.get("success"))),
                      "attempt_count": len(attempts),
                      "run_ids": report.get("run_ids") or [],
                      "started_at": report.get("started_at"),
                      "finished_at": report.get("finished_at"),
                      "elapsed_seconds": report.get("elapsed_seconds"),
                      "failure_class": report.get("failure_class") or "workflow_step_interrupted",
                      "failure_type": report.get("failure_type") or "workflow_interrupted",
                      "cause_code": report.get("cause_code") or "unknown",
                      "failure_reason": report.get("failure_reason") or "ingest step interrupted",
                      "timeout_attempts": sum(
                          1 for item in attempts
                          if (item.get("failure_class") == "timeout" or item.get("cause_code") == "timeout_request")
                      ),
                      "failure_class_counts": failure_counts,
                  },
                  "dead_letter_path": report.get("dead_letter_path"),
                  "attempt_timeline": attempts,
              }
              classification_path.parent.mkdir(parents=True, exist_ok=True)
              classification_path.write_text(json.dumps(artifact, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")

          if not comment_template_path.exists() and report.get("success") is False:
              repo = os.environ.get("GITHUB_REPOSITORY", "")
              run_id = os.environ.get("GITHUB_RUN_ID", "")
              server = os.environ.get("GITHUB_SERVER_URL", "https://github.com")
              run_url = f"{server}/{repo}/actions/runs/{run_id}" if repo and run_id else ""
              lines = [
                  "[DEVELOP][INGEST FAILURE TEMPLATE]",
                  "report_path: develop_report/YYYY-MM-DD_issueNNN_ingest_failure_report.md",
                  "evidence:",
                  f"- workflow_run: {run_url}",
                  f"- ingest_report: `{report_path}`",
                  f"- classification_artifact: `{classification_path}`",
                  f"- dead_letter: `{report.get('dead_letter_path')}`",
                  f"- failure_class: `{report.get('failure_class')}`",
                  f"- failure_type: `{report.get('failure_type')}`",
                  f"- cause_code: `{report.get('cause_code')}`",
                  f"- failure_reason: `{report.get('failure_reason')}`",
                  "next_status: status/in-progress",
              ]
              comment_template_path.parent.mkdir(parents=True, exist_ok=True)
              comment_template_path.write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY

      - name: Upload ingest report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ingest-schedule-report
          path: |
            data/ingest_schedule_report.json
            data/ingest_schedule_payload_route_report.json
            data/ingest_schedule_failure_classification.json
            data/ingest_schedule_failure_comment_template.md
          if-no-files-found: error

      - name: Upload dead-letter artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ingest-schedule-dead-letter
          path: data/dead_letter/*.json
          if-no-files-found: ignore
