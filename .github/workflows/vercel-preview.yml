name: Vercel Preview

on:
  workflow_dispatch:
    inputs:
      root_dir:
        description: "Public web root directory"
        required: true
        default: "apps/web"
        type: choice
        options:
          - apps/web
      issue_number:
        description: "Issue number to post preview URL"
        required: true
        type: string

permissions:
  contents: read
  issues: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    env:
      ROOT_DIR: ${{ inputs.root_dir }}
      ISSUE_NUMBER: ${{ inputs.issue_number }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_SCOPE: ${{ secrets.VERCEL_SCOPE }}
      VERCEL_PROJECT_NAME: ${{ secrets.VERCEL_PROJECT_NAME }}
      WEB_API_BASE_URL: https://2026-api-production.up.railway.app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight required Vercel secrets
        run: |
          missing=()
          [ -z "${VERCEL_TOKEN:-}" ] && missing+=("VERCEL_TOKEN")
          [ -z "${VERCEL_SCOPE:-}" ] && missing+=("VERCEL_SCOPE")
          [ -z "${VERCEL_PROJECT_NAME:-}" ] && missing+=("VERCEL_PROJECT_NAME")
          if [ "${#missing[@]}" -gt 0 ]; then
            echo "::error::Missing required repository secrets: ${missing[*]}"
            exit 1
          fi

      - name: Validate root directory
        run: |
          if [ ! -d "$ROOT_DIR" ]; then
            echo "::error::Root directory not found: $ROOT_DIR"
            exit 1
          fi
          if [ ! -f "$ROOT_DIR/package.json" ]; then
            echo "::error::package.json not found under root directory: $ROOT_DIR"
            exit 1
          fi

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ inputs.root_dir }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ inputs.root_dir }}

      - name: Build web app
        run: npm run build
        working-directory: ${{ inputs.root_dir }}
        env:
          API_BASE_URL: ${{ env.WEB_API_BASE_URL }}
          NEXT_PUBLIC_API_BASE_URL: ${{ env.WEB_API_BASE_URL }}

      - name: Deploy preview to Vercel
        id: deploy
        run: |
          set -o pipefail
          DEPLOY_LOG=/tmp/vercel-preview-deploy.log
          # Deploy from repository root to avoid rootDirectory double-appending
          # when the Vercel project itself already has rootDirectory configured.
          set +e
          npx vercel@latest deploy \
            --yes \
            --token "$VERCEL_TOKEN" \
            --scope "$VERCEL_SCOPE" \
            --name "$VERCEL_PROJECT_NAME" \
            --build-env API_BASE_URL="$WEB_API_BASE_URL" \
            --build-env NEXT_PUBLIC_API_BASE_URL="$WEB_API_BASE_URL" \
            --env API_BASE_URL="$WEB_API_BASE_URL" \
            --env NEXT_PUBLIC_API_BASE_URL="$WEB_API_BASE_URL" \
            2>&1 | tee "$DEPLOY_LOG"
          deploy_exit=${PIPESTATUS[0]}
          set -e

          if [ "$deploy_exit" -ne 0 ]; then
            if grep -Eiq "rate[ -]?limit|deployment rate limited|too many requests" "$DEPLOY_LOG"; then
              echo "::warning::Vercel deployment was rate-limited. Treating as non-blocking signal."
              echo "rate_limited=true" >> "$GITHUB_OUTPUT"
              echo "preview_url=" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "::error::Vercel deploy failed (exit=${deploy_exit})"
            exit "$deploy_exit"
          fi

          PREVIEW_URL=$(grep -Eo 'https://[^ ]+' "$DEPLOY_LOG" | grep 'vercel.app' | tail -n 1)
          if [ -z "$PREVIEW_URL" ]; then
            echo "::error::Preview URL was not found in deploy log"
            exit 1
          fi

          echo "rate_limited=false" >> "$GITHUB_OUTPUT"
          echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"

      - name: Verify preview URL accessibility
        id: verify
        run: |
          if [ "${{ steps.deploy.outputs.rate_limited }}" = "true" ]; then
            echo "verified=false" >> "$GITHUB_OUTPUT"
            echo "access_mode=rate_limited" >> "$GITHUB_OUTPUT"
            echo "status_code=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PREVIEW_URL="${{ steps.deploy.outputs.preview_url }}"
          status_code=""
          for _ in $(seq 1 10); do
            status_code=$(curl -sS -o /tmp/vercel-preview-home.html -w "%{http_code}" "$PREVIEW_URL" || true)
            if [ "$status_code" = "200" ] || [ "$status_code" = "301" ] || [ "$status_code" = "302" ] || [ "$status_code" = "307" ] || [ "$status_code" = "308" ]; then
              break
            fi
            sleep 3
          done

          if [ "$status_code" = "200" ] || [ "$status_code" = "301" ] || [ "$status_code" = "302" ] || [ "$status_code" = "307" ] || [ "$status_code" = "308" ]; then
            echo "verified=true" >> "$GITHUB_OUTPUT"
            echo "access_mode=public" >> "$GITHUB_OUTPUT"
            echo "status_code=$status_code" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::error::Preview URL accessibility check failed (status_code=${status_code:-none})"
          exit 1

      - name: Comment preview URL to issue
        if: ${{ success() && env.ISSUE_NUMBER != '' && steps.deploy.outputs.rate_limited != 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const previewUrl = "${{ steps.deploy.outputs.preview_url }}";
            const rootDir = process.env.ROOT_DIR;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const accessMode = "${{ steps.verify.outputs.access_mode }}";
            const statusCode = "${{ steps.verify.outputs.status_code }}";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "[DEVELOP] Vercel preview URL issued via CI.",
                "",
                `- root_dir: ${rootDir}`,
                `- preview_url: ${previewUrl}`,
                `- action_run: ${runUrl}`,
                `- access_mode: ${accessMode}`,
                `- status_code: ${statusCode}`,
                "",
                "Access verification: curl status check"
              ].join("\n")
            });

      - name: Comment rate-limit non-blocking note to issue
        if: ${{ success() && env.ISSUE_NUMBER != '' && steps.deploy.outputs.rate_limited == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const rootDir = process.env.ROOT_DIR;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "[DEVELOP] Vercel preview deployment was rate-limited (non-blocking policy applied).",
                "",
                `- root_dir: ${rootDir}`,
                `- action_run: ${runUrl}`,
                "- deploy_status: rate_limited_non_blocking",
                "- required_followup: attach manual staging smoke evidence for feature validation",
                "",
                "Operational policy: Vercel rate-limit is treated as deploy-signal only, not a functional gate."
              ].join("\n")
            });

      - name: Upload deploy artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vercel-preview-${{ github.run_id }}
          path: |
            /tmp/vercel-preview-deploy.log
            /tmp/vercel-preview-home.html
