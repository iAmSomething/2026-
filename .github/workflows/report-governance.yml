name: Report Governance

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-report-path:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR body has Report-Path
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail

          REPORT_PATH=$(printf "%s" "$PR_BODY" | sed -n 's/^Report-Path:[[:space:]]*//p' | head -n1)

          if [ -z "$REPORT_PATH" ]; then
            echo "::error::PR body must include 'Report-Path: <path>' line."
            exit 1
          fi

          if ! [[ "$REPORT_PATH" =~ ^(UIUX_reports|Collector_reports|develop_report)/[0-9]{4}-[0-9]{2}-[0-9]{2}_.+_report\.md$ ]]; then
            echo "::error::Invalid Report-Path format: $REPORT_PATH"
            exit 1
          fi

          echo "REPORT_PATH=$REPORT_PATH" >> "$GITHUB_ENV"

      - name: Ensure Report-Path file is included in PR changes
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --depth=1

          CHANGED_FILES=$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD)
          echo "$CHANGED_FILES"

          if ! printf "%s\n" "$CHANGED_FILES" | grep -Fx "$REPORT_PATH" >/dev/null; then
            echo "::error::Report file '$REPORT_PATH' is not in changed files."
            exit 1
          fi
